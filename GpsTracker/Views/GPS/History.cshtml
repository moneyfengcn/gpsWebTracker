@*@model List<Gps.DAL.Entitys.HistoryPosition>*@
<!-- Moment Plugin Js -->
<script src="~/plugins/momentjs/moment.js"></script>


<!-- Bootstrap Material Datetime Picker Css -->
<link href="~/plugins/bootstrap-material-datetimepicker/css/bootstrap-material-datetimepicker.css" rel="stylesheet" />

<!-- Bootstrap DatePicker Css -->
<link href="~/plugins/bootstrap-datepicker/css/bootstrap-datepicker.css" rel="stylesheet" />


<!-- Bootstrap Material Datetime Picker Plugin Js -->
<script src="~/plugins/bootstrap-material-datetimepicker/js/bootstrap-material-datetimepicker.js" charset="utf-8"></script>

<!-- Bootstrap Datepicker Plugin Js -->
<script src="~/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js" charset="utf-8"></script>

<div class="row clearfix">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card">
            <div class="header">
                <div class='row'>
                    <div class='col-sm-6'><h2>轨迹回放</h2></div>
                    <div class='col-sm-6' align="right" id="gpsinfo"> </div>
                </div>
            </div>
            <div class="body">
                <style>
                    .mapContainer {
                        position: relative;
                        width: 100%;
                        height: 100%;
                    }
                </style>

                <div class="jvector-map">
                    <div id="mapContainer" class="mapContainer"></div>
                </div>
            </div>
            <div class="footer">
                <div class="progress">
                    <div id="myProgressbar" class="progress-bar progress-bar-danger progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0"
                         aria-valuemax="100" style="width: 100%">
                        100%
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- #END# Inline Layout -->
<!-- Inline Layout | With Floating Label -->
<div class="row clearfix">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card">
            <div class="body">
                <div class="row clearfix">
                    <div class="col-sm-2">
                        <div class="form-group">
                            <div class="form-line">
                                <select class="form-control show-tick" id="devId">
                                    <option value="">-- 请选择设备 --</option>
                                    @foreach (var item in ViewBag.devList)
                                    {
                                        var dev = (GPSTracker.DAL.Entitys.GpsDevices)item;
                                        <option value="@dev.DeviceId">@dev.DeviceName</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="form-group">
                            <div class="form-line">
                                <input id="startTime1" type="text" class="datetimepicker form-control" placeholder="请选择起始日期和时间 ...">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <div class="form-group">
                            <div class="form-line">
                                <input id="endTime1" type="text" class="datetimepicker form-control" placeholder="请选择结束日期和时间 ...">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-2">
                        <select class="form-control show-tick" id="playSpeed">
                            <option value="100">快速回放</option>
                            <option value="400" selected>正常速度</option>
                            <option value="1000">慢速回放</option>
                        </select>
                    </div>
                    <div class="col-sm-2">
                        <input type="checkbox" id="filterZero" class="filled-in  chk-col-pink" checked>
                        <label for="filterZero">过滤速度为0的数据</label>

                        <button type="button" class="btn btn-primary btn-lg m-l-15 waves-effect" onclick="QueryHistoryPlay();">回放</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var map = new AMap.Map("mapContainer", {
        resizeEnable: true,
        center: [116.397428, 39.90923],
        zoom: 12
    });
    var marker = null;
    var _gpsPosition = null;

    function Playback(lineArr, playSpeed) {
        // JSAPI2.0 使用覆盖物动画必须先加载动画插件
        AMap.plugin('AMap.MoveAnimation', function () {
            // 绘制轨迹
            var polyline = new AMap.Polyline({
                map: map,
                path: lineArr,
                showDir: true,
                strokeColor: "#28F",  //线颜色
                // strokeOpacity: 1,     //线透明度
                strokeWeight: 6,      //线宽
                // strokeStyle: "solid"  //线样式
            });

            var passedPolyline = new AMap.Polyline({
                map: map,
                strokeColor: "#AF5",  //线颜色
                strokeWeight: 6,      //线宽
            });

            var _index = 0;

            marker.on('moving', function (e) {
                passedPolyline.setPath(e.passedPath);
                if (e.index != _index) {
                    _index = e.index;
                    var data = _gpsPosition[_index];

                    var text = '<center>' + data.device.deviceName + '<BR/>速度:' + data.speed + '<BR/>' + data.gpsTime + '</center>'
                    marker.setLabel({
                        offset: new AMap.Pixel(5, 5),  //设置文本标注偏移量
                        content: text, //设置文本标注内容
                        direction: 'bottom' //设置文本标注方位
                    });
                    //显示一份在右上角
                    $("#gpsinfo").text("速度：" + data.speed + "km/h  时间：" + data.gpsTime);

                    var point = e.target.getPosition();
                    if (!map.getBounds().contains(point)) {
                        //map.setCenter(point, true);
                        map.panTo(point);
                    }
                    console.info(e);

                    let value = Math.round((_index + 1) / _gpsPosition.length * 100);
                    showProgress(value);
                    if (value >= 100) {
                        swal("提示", "轨迹回放完毕！", "success");
                    }

                }
            });

            //map.setFitView();

            window.startAnimation = function startAnimation(nSpeed) {
                marker.moveAlong(lineArr, {
                    // 每一段的时长
                    duration: nSpeed,//可根据实际采集时间间隔设置
                    // JSAPI2.0 是否延道路自动设置角度在 moveAlong 里设置
                    autoRotation: true,
                });
                map.setZoom(12);
            };

            window.pauseAnimation = function () {
                marker.pauseMove();
            };

            window.resumeAnimation = function () {
                marker.resumeMove();
            };

            window.stopAnimation = function () {
                marker.stopMove();
            };
        });

        startAnimation(playSpeed);
    }



    function PlayHistory(data, playSpeed) {
        if (marker != null) {
            marker.stopMove();
            marker = null;
        }
        map.clearMap();

        marker = new AMap.Marker({
            map: map,
            position: [116.478935, 39.997761],
            icon: "https://a.amap.com/jsapi_demos/static/demo-center-v2/car.png",
            offset: new AMap.Pixel(-13, -26),
        });


        _gpsPosition = data;
        var lineArr = new Array();
        for (i = 0; i < _gpsPosition.length; i++) {
            var point = new Array(_gpsPosition[i].lng, _gpsPosition[i].lat);
            lineArr.push(point);
        }
        map.panTo(lineArr[0]);

        AMap.convertFrom(lineArr, 'gps', function (status, result) {
            if (result.info === 'ok') {
                var lnglats = result.locations; // Array.<LngLat>

                Playback(lnglats, playSpeed);
            }
        });
    }

    //查出历史轨迹 并且回放
    function QueryHistoryPlay() {
        carname = $('#devId').find('option:selected').text();
        var id = $('#devId').val();
        if (id == "") {
            swal("提示", "请选择需要回放轨迹的车辆", "success");
            return;
        }
        var filter = $("#filterZero").is(':checked');
        var startTime1 = $("#startTime1").val();
        var endTime1 = $("#endTime1").val();
        var playSpeed = $("#playSpeed").val();
        if (startTime1 == '') startTime1 = null;
        if (endTime1 == '') endTime1 = null;
        debugger;

        var obj = { deviceId: id, beginTime: startTime1, endTime: endTime1, filterZero: filter };
        $.ajax({
            url: "/api/Test/GetHistory",
            data: JSON.stringify(obj),
            contentType: "application/json",
            type: "POST",
            dataType: "json",
            success: function (data) {
                if (!data.state) {
                    alert(data.msg);
                } else if (data.data == null || data.data.length <= 0) {
                    swal("提示", "这个时间段内没有可用的轨迹数据", "success");
                }
                else {
                    PlayHistory(data.data, playSpeed);
                }
            }
        });
    }
    function showProgress(value) {
        var xx = value + '%'
        console.info('进度：' + xx);
        $("#myProgressbar").css('width', xx);
        $("#myProgressbar").text(xx);

    }
</script>


<script type="text/javascript">
    //Datetimepicker plugin
    $('.datetimepicker').bootstrapMaterialDatePicker({
        format: 'YYYY-MM-DDTHH:mm:00',
        clearButton: true,
        weekStart: 1
    });

    $('.datepicker').bootstrapMaterialDatePicker({
        format: 'dddd DD MMMM YYYY',
        clearButton: true,
        weekStart: 1,
        time: false
    });

    $('.timepicker').bootstrapMaterialDatePicker({
        format: 'HH:mm',
        clearButton: true,
        date: false
    });

    //Bootstrap datepicker plugin
    $('#bs_datepicker_container input').datepicker({
        autoclose: true,
        container: '#bs_datepicker_container'
    });

    $('#bs_datepicker_component_container').datepicker({
        autoclose: true,
        container: '#bs_datepicker_component_container'
    });
    //
    $('#bs_datepicker_range_container').datepicker({
        autoclose: true,
        container: '#bs_datepicker_range_container'
    });

                                                                                        //App.InitMap();

</script>


<script>

</script>
